================
Functional tests
================

This file is too big and should be cut into pieces.

    To see errors, add this just before the wanted line:
    >> browser.handleErrors = False
=======================
Adding an Eztranet site
=======================

We create the test browser

    >>> from zope.testbrowser.testing import Browser
    >>> browser = Browser()

We can connect to the root and we get a page that allow to add an eztranet::

    >>> browser.open('http://localhost/')
    >>> browser.headers['status']
    '200 Ok'

We click on the link to add an eztranet::

    >>> browser.getLink(url='add_eztranet.html').click()
    Traceback (most recent call last):
    ...
    httperror_seek_wrapper: HTTP Error 401: Unauthorized

Ok, we need to be authentified as main admin::

    >>> browser.addHeader('Authorization', 'Basic globalmgr:globalmgrpw')
    >>> browser.addHeader('Accept-Language', 'en-US')
    >>> browser.getLink(url='add_eztranet.html').click()
        
We fill in the form::

    >>> browser.getControl(name='form.widgets.__name__').value = 'eztranet'
    >>> browser.getControl(name='form.widgets.title').value = 'My Eztranet Site'
    >>> browser.getControl(name='form.buttons.add').click()

We should have both an EztranetSite object and a 'projects' subfolder::

    >>> root = getRootFolder()
    >>> 'projects' in root['eztranet']
    True

We also have a new 'admin' user in an auth folder::

    >>> from zope.app.component.hooks import getSiteManager
    >>> sm = getSiteManager(root['eztranet'])
    >>> 'admin' in sm['authentication']['EztranetUsers']
    True

We can now visit the eztranet site::

    >>> del browser
    >>> browser = Browser()
    >>> browser.open('http://localhost/eztranet')
    >>> browser.headers['status']
    '200 Ok'
    >>> 'Gorfou' in browser.contents
    True

We cannot yet visit the projects, and we are redirected
to a login page::

    >>> browser.open('http://localhost/eztranet/projects/')
    >>> '<input type="text" name="login" id="login" />' in browser.contents
    True

We fill in the user and password::

    >>> browser.getControl(name='login').value = 'admin'
    >>> browser.getControl(name='password').value = 'eztranet'
    >>> browser.getControl(name='SUBMIT').click()
    >>> browser.headers['status']
    '200 Ok'

Now we are in the projects page::

    >>> browser.url
    'http://localhost/eztranet/projects/@@index.html'


===============
Adding Projects
===============

We add two projects::

    >>> browser.getLink(url='add_project.html').click()
    >>> browser.getControl(name='form.widgets.title').value = u'   @@@ ++++  '
    >>> browser.getControl(name='form.widgets.description').value = u'project1 description'
    >>> browser.getControl(name='form.buttons.add').click()
    >>> 'Project' in root['eztranet']['projects']
    True
    >>> browser.getLink(url='add_project.html').click()
    >>> browser.getControl(name='form.widgets.title').value = u'project 2'
    >>> browser.getControl(name='form.widgets.description').value = u'project2 description'
    >>> browser.getControl(name='form.buttons.add').click()
    >>> [p in root['eztranet']['projects'] for p in ('Project','project-2')]
    [True, True]
    >>> browser.getLink(text='Projects').click()
    >>> '<a href="project-2">project 2</a>' in  browser.contents
    True
    >>> '<a href="Project">   @@@ ++++  </a>' in  browser.contents
    True


In each project we add a subproject

    >>> browser.getLink(text='@@@ ++++').click()
    >>> browser.getLink(text='New folder').click()
    >>> browser.getControl(name='form.widgets.title').value = u'subproject'
    >>> browser.getControl(name='form.widgets.description').value = u'subproject description'
    >>> browser.getControl(name='form.buttons.add').click()
    >>> browser.getLink(text='subproject').click()
    >>> 'subproject' in root['eztranet']['projects']['Project']
    True

    >>> browser.getLink(url='..').click()
    >>> browser.getLink(url='..').click()
    
    >>> browser.getLink(url='project-2').click()
    >>> browser.getLink(text='New folder').click()
    >>> browser.getControl(name='form.widgets.title').value = u'subproject'
    >>> browser.getControl(name='form.widgets.description').value = u'subproject description'
    >>> browser.getControl(name='form.buttons.add').click()
    >>> 'subproject' in root['eztranet']['projects']['project-2']
    True

We check the different views of the project-2::

    >>> browser.getLink('Modify').click()
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.getLink('New folder').click()
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.getLink('New file').click()
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.getLink('Comment').click()
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.getLink('Permissions').click()
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.getLink('Config.').click()
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.getLink('List').click()
    >>> 'New file' in browser.contents
    True
    >>> 'New folder' in browser.contents
    True

We check the different views of the subproject::

    >>> browser.getLink(url='subproject', index=1).click()
    >>> 'subproject' in browser.contents
    True
    >>> browser.getLink('List').click()
    >>> 'New file' in browser.contents
    True
    >>> 'New folder' in browser.contents
    True
    >>> browser.getLink('Modify').click()
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.getLink('New folder').click()
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.getLink('New file').click()
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.getLink('Comment').click()
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.getLink('Permissions').click()
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.getLink('Config.').click()
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False

==============
Adding a Video
==============

We add a video in the project-2::

    >>> browser.open('http://localhost/eztranet/projects/project-2/')
    >>> import eztranet.thumbnail
    >>> from os.path import join, dirname
    >>> videopath = join(dirname(eztranet.thumbnail.__file__), 'sample.ogg')
    >>> browser.getLink(text='New file').click()
    >>> browser.getControl(name='form.widgets.data').add_file(open(videopath), 'video/ogg', 'a sample.ogg')
    >>> browser.getControl(name='form.buttons.add').click()
    >>> '<a href="a-sample.ogg">a sample.ogg</a>' in browser.contents
    True
    >>> browser.getLink(url='a-sample.ogg').click()
    >>> '<span>a sample.ogg</span>' in browser.contents
    True
    >>> 'compressing' in browser.contents
    True

We check the different views::

    >>> browser.getLink('View').click()
    >>> 'New file' in browser.contents
    False
    >>> 'New folder' in browser.contents
    False
    >>> browser.getLink('Modify').click()
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.getLink('Comment').click()
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.getLink('Permissions').click()
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.getLink('Config.').click()
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False

We wait for the compression to finish::

    >>> import time
    >>> for i in range(10):
    ...     time.sleep(0.5)
    ...     browser.open('http://localhost/eztranet/projects/project-2/a-sample.ogg/')
    ...     if 'compressing' not in browser.contents or i > 9:
    ...         break
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False

We check the video views::

    >>> browser.open('http://localhost/eztranet/projects/project-2/a-sample.ogg/@@display')
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.open('http://localhost/eztranet/projects/project-2/a-sample.ogg/@@download')
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.open('http://localhost/eztranet/projects/project-2/a-sample.ogg/@@flv')
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False

    >>> browser.open('http://localhost/eztranet/projects/project-2/')

=====================================
We try to submit an empty add form::
=====================================

    >>> browser.getLink(text='New file').click()
    >>> browser.getControl(name='form.buttons.add').click()
    >>> 'system error' in browser.contents
    False

===============
Adding an Image
===============

We add an image in the project-2::

    >>> imagepath = join(dirname(eztranet.thumbnail.__file__), 'sample.png')
    >>> browser.open('http://localhost/eztranet/projects/project-2/')
    >>> browser.getLink(text='New file').click()
    >>> browser.getControl(name='form.widgets.data').add_file(open(imagepath), 'image/png', 'a sample.png')
    >>> browser.getControl(name='form.buttons.add').click()
    >>> '<a href="a-sample.png">a sample.png</a>' in browser.contents
    True
    >>> browser.getLink(url='a-sample.png').click()
    >>> '<span>a sample.png</span>' in browser.contents
    True

We check the different views::

    >>> browser.getLink('View').click()
    >>> 'New file' in browser.contents
    False
    >>> 'New folder' in browser.contents
    False
    >>> browser.getLink('Modify').click()
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.getLink('Comment').click()
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.getLink('Permissions').click()
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.open('http://localhost/eztranet/projects/project-2/a-sample.png/@@display')
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.open('http://localhost/eztranet/projects/project-2/a-sample.png/@@download')
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False

    >>> browser.open('http://localhost/eztranet/projects/project-2/')

==============
Adding an item
==============
We add an item (some text) in the project-2::

    >>> from StringIO import StringIO
    >>> browser.getLink(text='New file').click()
    >>> browser.getControl(name='form.widgets.data').add_file(StringIO('dummytext'),
    ...                                               'text/plain',
    ...                                               'dummytext.txt')
    >>> browser.getControl(name='form.buttons.add').click()
    **Hachoir determination failed**
    >>> '<a href="dummytext.txt">dummytext.txt</a>' in browser.contents
    True
    >>> browser.getLink(url='dummytext.txt').click()
    >>> '<span>dummytext.txt</span>' in browser.contents
    True

We check the different views::

    >>> browser.getLink('View').click()
    >>> 'New file' in browser.contents
    False
    >>> 'New folder' in browser.contents
    False
    >>> browser.getLink('Modify').click()
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.getLink('Comment').click()
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.getLink('Permissions').click()
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.getLink('Project').click()
    >>> browser.open('http://localhost/eztranet/projects/project-2/dummytext.txt/@@display')
    >>> browser.headers['status']
    '200 Ok'
    >>> browser.open('http://localhost/eztranet/projects/project-2/dummytext.txt/@@download')
    >>> browser.headers['status']
    '200 Ok'

    >>> list(root['eztranet']['projects']['project-2'])
    [u'a-sample.ogg', u'a-sample.png', u'dummytext.txt', u'subproject']
    >>> list(root['eztranet']['projects']['Project'])
    [u'subproject']


================
Read permissions
================

    >>> browser.open('http://localhost/eztranet/projects/project-2/')

We create a new user 'testuser'::

    >>> browser.getLink(text='Users').click()
    >>> browser.getLink(text='New user').click()
    >>> browser.getControl(name='form.widgets.login').value = u'testuser'
    >>> browser.getControl(name='form.widgets.password').value = u'testpass'
    >>> browser.getControl(name='form.buttons.add').click()
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False


We set the read permissions on project-2 to the user

    >>> browser.getLink(text='Projects').click()
    >>> browser.getLink(text='project 2').click()
    >>> browser.getLink(text='Permissions').click()
    >>> browser.getControl(name='eztranet.project.Member').options
    ['admin', 'testuser']
    >>> browser.getControl(name='eztranet.project.Member').value = ['testuser']
    >>> browser.getControl(name='GRANT_SUBMIT').click()

We logout, revisit the projects and login as the new user::

    >>> browser.getLink(text='Logout').click()
    >>> browser.getLink(text='Projects').click()
    >>> browser.getControl(name='login').value = 'testuser'
    >>> browser.getControl(name='password').value = 'testpass'
    >>> browser.getControl(name='SUBMIT').click()

We only see the authorized project::

    >>> '<a href="project-2">project 2</a>' in  browser.contents
    True
    >>> '<a href="Project">' in  browser.contents
    False

Trying to see the unauthorized pages leads to an error::

    >>> browser.open('http://localhost/eztranet/projects/Project')
    Traceback (most recent call last):
    ...
    httperror_seek_wrapper: HTTP Error 403: Forbidden
    >>> browser.open('http://localhost/eztranet/projects/Project/@@permissions.html')
    Traceback (most recent call last):
    ...
    httperror_seek_wrapper: HTTP Error 403: Forbidden
    >>> browser.open('http://localhost/eztranet/projects/Project/@@edit.html')
    Traceback (most recent call last):
    ...
    httperror_seek_wrapper: HTTP Error 403: Forbidden
    >>> browser.open('http://localhost/eztranet/projects/Project/@@comments.html')
    Traceback (most recent call last):
    ...
    httperror_seek_wrapper: HTTP Error 403: Forbidden
    >>> browser.open('http://localhost/eztranet/projects/project-2/@@permissions.html')
    Traceback (most recent call last):
    ...
    httperror_seek_wrapper: HTTP Error 403: Forbidden
    >>> browser.open('http://localhost/eztranet/projects/project-2/@@edit.html')
    Traceback (most recent call last):
    ...
    httperror_seek_wrapper: HTTP Error 403: Forbidden


    >>> browser.open('http://localhost/eztranet/projects/project-2/@@permissions.html')
    Traceback (most recent call last):
    ...
    httperror_seek_wrapper: HTTP Error 403: Forbidden

We cannot delete the project:

    >>> browser.getLink(text='Projects').click()
    >>> browser.getControl(name='contents-checkBoxColumn-0-selectedItems').options
    ['project-2']
    >>> browser.getControl(name='contents-checkBoxColumn-0-selectedItems').value = ['project-2']
    >>> browser.getControl(name="contents.buttons.delete").click()
    Traceback (most recent call last):
    ...
    httperror_seek_wrapper: HTTP Error 403: Forbidden

=================
Write permissions
=================

We authorize testuser to modify Project but not read project-2::

    >>> browser.getLink(text='Logout').click()
    >>> browser.getControl(name='login').value = 'admin'
    >>> browser.getControl(name='password').value = 'eztranet'
    >>> browser.getControl(name='SUBMIT').click()
    >>> browser.open('http://localhost/eztranet/projects/Project/@@permissions.html')
    >>> browser.getControl(name='eztranet.project.Member').value = []
    >>> browser.getControl(name='eztranet.project.Manager').value = ['testuser']
    >>> browser.getControl(name='GRANT_SUBMIT').click()
    >>> browser.open('http://localhost/eztranet/projects/project-2/@@permissions.html')
    >>> browser.getControl(name='eztranet.project.Member').value = []
    >>> browser.getControl(name='eztranet.project.Manager').value = []
    >>> browser.getControl(name='GRANT_SUBMIT').click()

Then we visit the project as testuser::

    >>> browser.open('http://localhost/eztranet/projects/')
    >>> browser.getLink(text='Logout').click()
    >>> browser.getControl(name='login').value = u'testuser'
    >>> browser.getControl(name='password').value = u'testpass'
    >>> browser.getControl(name='SUBMIT').click()

We only see the authorized project::

    >>> '<a href="project-2">' in  browser.contents
    False
    >>> '<a href="Project">' in  browser.contents
    True

Trying to see the unauthorized project leads to an error::

    >>> browser.open('http://localhost/eztranet/projects/project-2')
    Traceback (most recent call last):
    ...
    httperror_seek_wrapper: HTTP Error 403: Forbidden
    >>> browser.open('http://localhost/eztranet/projects/project-2/@@permissions.html')
    Traceback (most recent call last):
    ...
    httperror_seek_wrapper: HTTP Error 403: Forbidden
    >>> browser.open('http://localhost/eztranet/projects/project-2/@@edit.html')
    Traceback (most recent call last):
    ...
    httperror_seek_wrapper: HTTP Error 403: Forbidden
    >>> browser.open('http://localhost/eztranet/projects/project-2/@@comments.html')
    Traceback (most recent call last):
    ...
    httperror_seek_wrapper: HTTP Error 403: Forbidden
    >>> browser.open('http://localhost/eztranet/projects/project-2/@@permissions.html')
    Traceback (most recent call last):
    ...
    httperror_seek_wrapper: HTTP Error 403: Forbidden
    >>> browser.open('http://localhost/eztranet/projects/project-2/@@add_project.html')
    Traceback (most recent call last):
    ...
    httperror_seek_wrapper: HTTP Error 403: Forbidden
    >>> browser.open('http://localhost/eztranet/projects/project-2/@@add_projectitem.html')
    Traceback (most recent call last):
    ...
    httperror_seek_wrapper: HTTP Error 403: Forbidden

But we ca see all the views for the project we are manager of, excepted
permissions::

    >>> browser.open('http://localhost/eztranet/projects/Project/')
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.open('http://localhost/eztranet/projects/Project/@@edit.html')
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.open('http://localhost/eztranet/projects/Project/@@comments.html')
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.open('http://localhost/eztranet/projects/Project/@@add_project.html')
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.open('http://localhost/eztranet/projects/Project/@@add_projectitem.html')
    >>> browser.headers['status']
    '200 Ok'
    >>> 'system error' in browser.contents
    False
    >>> browser.open('http://localhost/eztranet/projects/Project/@@permissions.html')
    Traceback (most recent call last):
    ...
    httperror_seek_wrapper: HTTP Error 403: Forbidden

We cannot delete the project:

    >>> browser.getLink(text='Projects').click()
    >>> browser.getControl(name='contents-checkBoxColumn-0-selectedItems').options
    ['Project']
    >>> browser.getControl(name='contents-checkBoxColumn-0-selectedItems').value = ['Project']
    >>> browser.getControl(name="contents.buttons.delete").click()
    Traceback (most recent call last):
    ...
    httperror_seek_wrapper: HTTP Error 403: Forbidden

We authorize testuser to modify Project but not read project-2::

    >>> browser.getLink(text='Logout').click()
    >>> browser.getControl(name='login').value = 'admin'
    >>> browser.getControl(name='password').value = 'eztranet'
    >>> browser.getControl(name='SUBMIT').click()
    >>> browser.open('http://localhost/eztranet/projects/Project/@@permissions.html')
    >>> browser.getControl(name='eztranet.project.Member').value = []
    >>> browser.getControl(name='eztranet.project.Manager').value = []
    >>> browser.getControl(name='GRANT_SUBMIT').click()
    >>> browser.open('http://localhost/eztranet/projects/project-2/@@permissions.html')
    >>> browser.getControl(name='eztranet.project.Member').value = ['testuser']
    >>> browser.getControl(name='eztranet.project.Manager').value = []
    >>> browser.getControl(name='GRANT_SUBMIT').click()

Then we visit the project as testuser::

    >>> browser.open('http://localhost/eztranet/projects/')
    >>> browser.getLink(text='Logout').click()
    >>> browser.getControl(name='login').value = u'testuser'
    >>> browser.getControl(name='password').value = u'testpass'
    >>> browser.getControl(name='SUBMIT').click()

================
Adding a comment
================

We can add a comment to the project::

    >>> browser.open('http://localhost/eztranet/projects/project-2/@@comments.html')
    >>> browser.getControl(name='text').value = 'this is a comment'
    >>> browser.getControl(name='save').click()
    >>> 'this is a comment' in browser.contents
    True
    >>> browser.getControl(name='text').value = 'this is a second comment'
    >>> browser.getControl(name='save').click()
    >>> 'this is a second comment' in browser.contents
    True
    >>> 'this is a comment' in browser.contents
    True

We cannot delete a comment::

    >>> 'delete' in browser.contents
    False
    >>> browser.open('http://localhost/eztranet/projects/project-2/@@comments.html?del=1')
    Traceback (most recent call last):
    ...
    httperror_seek_wrapper: HTTP Error 403: Forbidden

However we can login as admin and delete the first comment::

    >>> browser.getLink(text='Logout').click()
    >>> browser.getLink(text='Projects').click()
    >>> browser.getControl(name='login').value = 'admin'
    >>> browser.getControl(name='password').value = 'eztranet'
    >>> browser.getControl(name='SUBMIT').click()
    >>> browser.getLink(text='project 2').click()
    >>> browser.getLink(text='Comment').click()
    >>> 'this is a comment' in browser.contents
    True
    >>> 'this is a second comment' in browser.contents
    True
    >>> browser.getLink(text='delete', index=0).click()
    >>> 'this is a comment' in browser.contents
    False
    >>> 'this is a second comment' in browser.contents
    True

Trying to delete a non existent comment does nothing::

    >>> browser.open('http://localhost/eztranet/projects/project-2/@@comments.html?del=0')
    >>> browser.open('http://localhost/eztranet/projects/project-2/@@comments.html?del=-1')
    >>> browser.open('http://localhost/eztranet/projects/project-2/@@comments.html?del=invalid')
    >>> browser.headers['status']
    '200 Ok'
    >>> 'this is a second comment' in browser.contents
    True

We can also add a comment to a video::

    >>> browser.open('http://localhost/eztranet/projects/project-2/a-sample.ogg/@@comments.html')
    >>> browser.getControl(name='text').value = 'this is a comment'
    >>> browser.getControl(name='save').click()
    >>> 'this is a comment' in browser.contents
    True
    >>> browser.getControl(name='text').value = 'this is a second comment'
    >>> browser.getControl(name='save').click()
    >>> 'this is a second comment' in browser.contents
    True
    >>> 'this is a comment' in browser.contents
    True

Or an image::

    >>> browser.open('http://localhost/eztranet/projects/project-2/a-sample.png/@@comments.html')
    >>> browser.getControl(name='text').value = 'this is a comment'
    >>> browser.getControl(name='save').click()
    >>> 'this is a comment' in browser.contents
    True
    >>> browser.getControl(name='text').value = 'this is a second comment'
    >>> browser.getControl(name='save').click()
    >>> 'this is a second comment' in browser.contents
    True
    >>> 'this is a comment' in browser.contents
    True

=====================
Resetting permissions
=====================

We delete the firsts project and add it again
to check that testuser cannot access it after recreation::

    >>> browser.getLink(text='Projects').click()
    >>> sorted(browser.getControl(name='contents-checkBoxColumn-0-selectedItems').options)
    ['Project', 'project-2']
    >>> browser.getControl(name='contents-checkBoxColumn-0-selectedItems').value = ['Project']
    >>> browser.getControl(name="contents.buttons.delete").click()

    >>> browser.getLink(text='New folder').click()
    >>> browser.getControl(name='form.widgets.title').value = u'Project'
    >>> browser.getControl(name='form.widgets.description').value = u'project description'
    >>> browser.getControl(name='form.buttons.add').click()

We should not be able to view it as testuser::

    >>> browser.getLink(text='Projects').click()
    >>> browser.getLink(text='Logout').click()
    >>> browser.getControl(name='login').value = 'testuser'
    >>> browser.getControl(name='password').value = 'testpass'
    >>> browser.getControl(name='SUBMIT').click()
    >>> '<a href="Project">project</a>' in  browser.contents
    False
    >>> browser.open('http://localhost/eztranet/projects/project')
    Traceback (most recent call last):
    ...
    httperror_seek_wrapper: HTTP Error 403: Forbidden

We give access to Project to testuser again,
then we delete and add again testuser
to check that the new testuser cannot access the Project::

    >>> browser.getLink(text='Projects').click()
    >>> browser.getLink(text='Logout').click()
    >>> browser.getControl(name='login').value = 'admin'
    >>> browser.getControl(name='password').value = 'eztranet'
    >>> browser.getControl(name='SUBMIT').click()
    >>> browser.getLink(text='Project', index=1).click()
    >>> browser.getLink(text='Permissions').click()
    >>> browser.getControl(name='eztranet.project.Member').options
    ['admin', 'testuser']
    >>> browser.getControl(name='eztranet.project.Member').value = ['testuser']
    >>> browser.getControl(name='GRANT_SUBMIT').click()

Before deleting the testuser, we first add a projectitem in the Project
to check that the recursive deletion of permissions works:

    >>> browser.getLink(text='New file').click()
    >>> browser.getControl(name='form.widgets.data').add_file(StringIO('dummytext'),
    ...                                               'text/plain',
    ...                                               'dummytext.txt')
    >>> browser.getControl(name='form.buttons.add').click()
    **Hachoir determination failed**
    >>> browser.getLink(url='..').click()

Now we delete the testuser

    >>> browser.getLink(text='Users').click()
    >>> browser.getControl(name='contents-checkBoxColumn-0-selectedItems').options
    ['admin', 'testuser']
    >>> browser.getControl(name='contents-checkBoxColumn-0-selectedItems').value = ['testuser']
    >>> browser.getControl(name="contents.buttons.delete").click()

    >>> browser.getLink(text='New user').click()
    >>> browser.getControl(name='form.widgets.login').value = u'testuser'
    >>> browser.getControl(name='form.widgets.password').value = u'testpass'
    >>> browser.getControl(name='form.buttons.add').click()

    >>> browser.getLink(text='Projects').click()
    >>> browser.getLink(text='Logout').click()
    >>> browser.getControl(name='login').value = 'testuser'
    >>> browser.getControl(name='password').value = 'testpass'
    >>> browser.getControl(name='SUBMIT').click()
    
    >>> '<a href="Project">Project</a>' in  browser.contents
    False
    >>> browser.open('http://localhost/eztranet/projects/project')
    Traceback (most recent call last):
    ...
    httperror_seek_wrapper: HTTP Error 403: Forbidden

=========================
Check the language choice
=========================

    >>> browser.getLink(text='Projects').click()
    >>> 'Here is' in browser.contents
    True
    >>> browser.getControl('english').selected=True
    >>> browser.getControl(name='lang.submit').click()
    >>> 'Here is' in browser.contents
    True
    >>> browser.getControl('franÃ§ais').selected=True
    >>> browser.getControl(name='lang.submit').click()
    >>> 'Voici' in browser.contents
    True
    >>> browser.getControl('auto').selected=True
    >>> browser.getControl(name='lang.submit').click()
    >>> 'Here is' in browser.contents
    True

====================================
Check the batching mode of z3c.table
====================================

We add 30 folders::

    >>> list(root['eztranet']['projects'])
    [u'project', u'project-2']
    >>> from eztranet.project.project import Project
    >>> for i in range(3, 33):
    ...     root['eztranet']['projects']['project-%s' % i] = Project()

Login as admin and browse the large list of projects::

    >>> browser.getLink(text='Logout').click()
    >>> browser.getControl(name='login').value = 'admin'
    >>> browser.getControl(name='password').value = 'eztranet'
    >>> browser.getControl(name='SUBMIT').click()
    >>> browser.open('http://localhost/eztranet/projects/')
    >>> 'project-32' in browser.contents
    True
    >>> 'system error' in browser.contents
    False

===========================
Removing items and projects
===========================

    >>> list(root['eztranet']['projects']['project-2'])
    [u'a-sample.ogg', u'a-sample.png', u'dummytext.txt', u'subproject']
    >>> list(root['eztranet']['projects']['project'])
    [u'dummytext.txt']

We remove every project excepted the Project and project-2::

    >>> browser.open('http://localhost/eztranet/projects/')
    >>> options = sorted(browser.getControl(name='contents-checkBoxColumn-0-selectedItems').options)
    >>> options
    ['project', 'project-10', 'project-11',..., 'project-9']
    >>> len(options)
    32
    >>> options.remove('project')
    >>> options.remove('project-2')
    >>> browser.getControl(name='contents-checkBoxColumn-0-selectedItems').value = options
    >>> browser.getControl(name="contents.buttons.delete").click()
    >>> browser.getControl(name='contents-checkBoxColumn-0-selectedItems').options
    ['project', 'project-2']

We remove the image and video::

    >>> browser.open('http://localhost/eztranet/projects/project-2/')
    >>> options = browser.getControl(name='contents-checkBoxColumn-0-selectedItems').options
    >>> options
    ['a-sample.ogg', 'a-sample.png', 'dummytext.txt', 'subproject']
    >>> browser.getControl(name='contents-checkBoxColumn-0-selectedItems').value = options
    >>> browser.getControl(name="contents.buttons.delete").click()
    >>> list(root['eztranet']['projects']['project-2'])
    []






